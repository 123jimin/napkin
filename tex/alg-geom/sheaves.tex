\chapter{Sheaves and ringed spaces}
Most of the complexity of the affine variety $V$ earlier comes from $\OO_V$.
This is a type of object called a ``sheaf''.
The purpose of this chapter is to completely define what this sheaf is,
and just what it is doing.

The typical example to keep in mind is a sheaf of
``functions with property $P$'' on a topological space $X$:
for every open set $U$, $\SF(U)$ gives us the ring of functions on $X$.
However, we will work very abstractly and only assume $\SF(U)$
is a ring, without an interpretation as ``functions''.

The payoff for this abstraction is that it will
allow us to define an arbitrary scheme in the next chapter.
Varieties use $\CC[x_1, x_2, \dots, x_n] / I$ as their ``ring of functions'',
and by using the fully general sheaf we will be replace this
with \emph{any} commutative ring.
In particular, we can use the case where $I$ is not radical, such as
$\CC[x] / (x^2)$; this gives the ``multiplicity''
behavior that we sought after all along.

\section{Pre-sheaves}
\prototype{The sheaf of holomorphic (or regular, continuous,
differentiable, constant, whatever) functions.}

The proper generalization of our $\OO_V$ is a so-called sheaf of rings.
Recall that $\OO_V$ took \emph{open sets of $V$} to \emph{rings},
with the interpretation that $\OO_V(U)$ was a ``ring of functions''.

In light of this, we first define:
\begin{definition}
	For a topological space $X$ let $\Opens(X)$ denote
	its open sets of $X$.
\end{definition}

So here is the official definition of a pre-sheaf.
\begin{definition}
	A \vocab{pre-sheaf} of rings on a space $X$ is a function
	\[ \SF : \Opens(X) \to \catname{Rings} \]
	meaning each open set gets associated with a ring $\SF(U)$.
	Each individual element of $\SF(U)$ is called a \vocab{section}.
	An element of $\SF(X)$ is called a \vocab{global section}.

	It is also equipped with a \vocab{restriction map}
	for any $U_1 \subseteq U_2$; this is a map
	\[ \res_{U_1,U_2} : \SF(U_2) \to \SF(U_1) \]
	such that $\res_{U,U}$ is the identity and
	whenever $U_1 \subseteq U_2 \subseteq U_3$ the diagram
	\begin{diagram}
		\SF(U_3) & \rTo^{\res_{U_2,U_3}} & \SF(U_2) \\
		& \rdTo_{\res_{U_1,U_3}} & \dTo_{\res_{U_1,U_2}} \\
		&& \SF(U_1)
	\end{diagram}
	commutes. (Restricting ``big to medium to small''
	is the same as ``big to small''.)
\end{definition}

\begin{abuse}
	If $s \in \mathscr F(U_2)$ is some section and $U_1 \subseteq U_2$,
	then rather than write $\res_{U_1,U_2}(s)$
	I will write $s\restrict{U_1}$ instead:
	``$s$ restricted to $U_1$''.
	This is abuse of notation because the section $s$ is just
	an element of some ring, and in the most abstract of cases
	may not have a natural interpretation as function.
\end{abuse}

\begin{example}[Examples of pre-sheaves]
	\listhack
	\begin{enumerate}[(a)]
		\ii For an affine variety $V$, $\OO_V$ is of course a sheaf,
		with $\OO_V(U)$ being the ring of regular functions on $U$.
		The restriction map just says that if $U_1 \subseteq U_2$,
		then a function $s \in \OO_V(U_2)$ can also be thought of as
		a function $s \restrict{U_1} \in \OO_V(U_1)$,
		hence the name ``restriction''.
		The commutativity of the diagram then follows.
		
		\ii Let $X \subseteq \RR^n$ be an open set.
		Then there is a sheaf of smooth/differentiable/etc.\ functions on $X$.
		In fact, one can do the same construction for any manifold $M$.

		\ii Similarly, if $X \subseteq \CC$ is open,
		we can construct a sheaf of holomorphic functions on $X$.
	\end{enumerate}
	In all these examples, the sections $s \in \SF(U)$
	are really functions on the space, but in general they need not be.
\end{example}

If you like category theory,
we can give a second equivalent (shorter) definition.
\begin{abuse}
	By abuse of notation, $\Opens(X)$ will also be thought of as a
	posetal category by inclusion. Thus $\varnothing$ is an initial object
	and the entire space $X$ is a terminal object.
\end{abuse}
\begin{definition}
	A \vocab{pre-sheaf} of rings on $X$ is a contravariant functor
	\[ \SF : \Opens(X)\op \to \catname{Rings}. \]
\end{definition}
\begin{exercise}
	Check that these definitions are equivalent.
\end{exercise}
So it is possible to replace $\catname{Rings}$ with any category we want.
We will not need to do so, but it's worth mentioning.

In practice, thinking about the restriction maps
might be more confusing than helpful; it is better to say:
\begin{moral}
	Pre-sheaves should be thought of as
	``returning the ring of functions with a property $P$''.
\end{moral}

\section{Sheaves}
\prototype{Constant functions aren't sheaves,
	but locally constant ones are.}

Now, the main idea next is that
\begin{moral}
	Sheaves are pre-sheaves for which $P$ is a \emph{local} property.
\end{moral}

The formal definition doesn't illuminate this as much as the examples
do, but I have to give it first for the examples to make sense.
\begin{definition}
	A \vocab{sheaf} $\mathscr F$ is a pre-sheaf obeying two additional axioms:
	Suppose $U$ is covered by open sets $U_\alpha \subseteq U$. Then:
	\begin{enumerate}
		\ii (Identity) If $s, t \in \mathscr F(U)$ are sections,
		and $s\restrict{U_\alpha} = t\restrict{U_\alpha}$
		for all $\alpha$, then $s = t$.
		\ii (Collation) Consider sections
		$s_\alpha \in \mathscr(U_\alpha)$ for each $\alpha$.
		Suppose that 
		\[ s_\alpha \restrict{U_\alpha \cap U_\beta}
			= s_\beta \restrict{U_\alpha \cap U_\beta} \]
		for each $U_\alpha$ and $U_\beta$.
		Then we can find $s \in U$ such that
		$s \restrict{U_\alpha}  = s_\alpha$.
	\end{enumerate}
\end{definition}
This is best illustrated by picture: consider an open cover $U_1 \cup U_2$.
\begin{center}
	\begin{asy}
		size(4cm);
		filldraw(shift(-0.5,0)*unitcircle, lightred+opacity(0.3), red);
		filldraw(shift( 0.5,0)*unitcircle, lightblue+opacity(0.3), blue);
		label("$U_1$", (-0.5,0)+dir(135), dir(135), red);
		label("$U_2$", ( 0.5,0)+dir(45), dir(45), blue);
	\end{asy}
\end{center}
Then for a sheaf of functions, the axioms are saying that:
\begin{itemize}
	\ii If $s$ and $t$ are functions (with property $P$)
	on the whole space $U = U_1 \cup U_2$,
	and $s \restrict{U_1} = t \restrict{U_1}$,
	$s \restrict{U_2} = t \restrict{U_2}$,
	then $s = t$ on the entire union.
	This is clear.

	\ii If $s_1$ is a function with property $P$ on $U_1$
	and $s_2$ is a function with property $P$ on $U_2$,
	and the two functions agree on the overlap,
	then one can collate them to obtain a function $s$
	on the whole space:
	this is obvious, but \textbf{the catch is that the collated function
	needs to have property $P$ as well.}
	That's why it matters that $P$ is local.
\end{itemize}

The reason we need these axioms is that in our abstract definition of a sheaf,
the output of the sheaf is an abstract ring, which need not actually
have a concrete interpretation as ``functions on $X$'', even though
our examples will usually have this property.

Now for the examples, which are more enlightening:
\begin{example}
	[Examples and non-examples of sheaves]
	\listhack
	\begin{enumerate}[(a)]
		\ii Pre-sheaves of arbitrary / continuous / differentiable / smooth
		/ holomorphic functions are still sheaves.
		This is because to verify a function is continuous,
		one only needs to look at small neighborhoods at once.
		
		\ii For a complex variety $V$, $\OO_V$ is a sheaf,
		precisely because our definition was \emph{locally} quotients
		of polynomials.

		\ii The pre-sheaf of \emph{constant} real functions on a space $X$
		is \emph{not} a sheaf, because it fails the collation axiom.
		Namely, suppose that $U_1 \cap U_2 = \varnothing$.
		Then if $s_1$ is the constant function $1$ on $U_1$
		while $s_2$ is the constant function $2$ on $U_2$,
		then we cannot collate these to a constant function on $U_1 \cup U_2$.

		\ii On the other hand, \emph{locally constant} functions
		do produce a sheaf. (A function is locally constant
		if for every point it is constant on some neighborhood.)
	\end{enumerate}
	In fact, the sheaf in (d) is what is called a \emph{sheafification}
	of the pre-sheaf constant functions, which we define momentarily.
\end{example}

\section{Stalks and germs}
\prototype{Germs of real smooth functions tell you the derivatives,
but germs of holomorphic functions determine the entire function.}

Let $\SF$ be a sheaf now.
Let $s \in \SF(U)$ be a section and $p \in U$.
We want to think of $s$ as a function on $U$ in our examples,
but in general $\SF(U)$ is a generic ring, and can't be evaluated at a point.
However, instead we can try to define a so-called \emph{germ},
which tries to capture this notion.

\begin{definition}
	Let $\SF$ be a sheaf of rings.
	For every point $p$ we define the \vocab{stalk} $\SF_p$ to be the set
	\[ \left\{ (s, U) \mid s \in \SF(U), p \in U \right\} \]
	modulo the relation $\sim$ that 
	\[ (s_1,U_1) \sim (s_2, U_2) \text{ if }
		s_1 \restrict{U_1 \cap U_2} = s_2 \restrict{U_1 \cap U_2}. \]
	The equivalence classes themselves are called \vocab{germs}.
\end{definition}

\begin{definition}
	The germ of a given $s \in \SF(U)$ at a point $p$
	is the equivalence class for $(s,U) \in \SF_p$.
	We denote this by $[s]_p$.
\end{definition}

\begin{remark}
	It is rarely useful to think of a germ as an ordered pair,
	since the set $U$ can get arbitrarily small.
	Instead, one should think of a germ as a
	``shred'' of some section near $p$.
\end{remark}

So what's happening is: We consider functions $s$ defined near $p$
and, since we only care about local behavior,
we identify any two functions agreeing on a neighborhood of $p$,
no matter how small.

Notice that the stalk is itself a ring as well:
for example, addition is done by
\[
	\left( s_1, U_1 \right) + \left( s_2, U_2 \right)
	=
	\left( s_1 \restrict{U_1 \cap U_2} + s_2 \restrict{U_1 \cap U_2},
	U_1 \cap U_2 \right).
\]

So the germ $[s]_p$ now plays the role of the ``value'' $s(p)$.
But actually, it carries much more information than that.

\begin{example}
	[Germs of real smooth functions]
	Let $X = \RR$ and let $\SF$ be the sheaf on $X$ of smooth functions
	(i.e.\ $\SF(U)$ is the set of smooth real-valued functions on $U$).

	Consider a global section, $s : \RR \to \RR$ (thus $s \in \SF(X)$)
	and its germ at $0$.
	\begin{enumerate}[(a)]
		\ii From the germ we can read off $s(0)$, obviously.
		\ii We can also find $s'(0)$, because the germ carries enough
		information to compute the limit $\lim_{h \to 0} \frac1h[s(h)-s(0)]$.
		\ii Similarly, we can compute the second derivative and so on.
		\ii However, we can't read off, say, $s(3)$ from the germ.
		For example, take the bump function
		\[
			s(x) = \begin{cases}
				e^{-\frac{1}{x-1}} & x > 1 \\
				0 & x \le 1.
			\end{cases}
		\]
		Note $s(3) = e^{-\half}$, but $[\text{zero function}]_0 = [s]_0$.
		So germs can't distinguish between the zero function and $s$.
	\end{enumerate}
\end{example}
\todo{when bump function is added to Calc 101,
link it here}

A nice summary for the right mindset might be:
\begin{moral}
	A germ is an ``enriched value'';
	the stalk is the set of possible enriched values.
\end{moral}

\begin{example}
	[Germs of holomorphic functions]
	Holomorphic functions are surprising in this respect.
	Consider the sheaf $\SF$ on $\CC$ of \emph{holomorphic} functions.

	Take $s : \CC \to \CC$ a global section.
	Given the germ of $s$ at $0$, we can read off $s(0)$, $s'(0)$, et cetera.
	The miracle of complex analysis is that just knowing
	the derivatives of $s$ at zero is enough to reconstruct all of $s$:
	we can compute the Taylor series of $s$ now.
	\textbf{Thus germs of holomorphic functions determine the entire function};
	they ``carry more information'' than their real counterparts.
	
	In particular, we can concretely describe the sheaf:
	\[
		\SF_p = \left\{
			\sum_{k \ge 0} c_k (z-p)^k
			\text{ convergent near $p$}
		\right\}.
	\]
	In particular, this includes germs of meromorphic functions,
	so long as there is no pole at $p$ itself.
\end{example}

And of course, our algebraic geometry example.
\begin{abuse}
	Rather than writing $(\OO_X)_p$ we will write $\OO_{X,p}$.
\end{abuse}
\begin{example}
	[Stalks of the sheaf on an affine variety]
	Let $V \subseteq \Aff^n$ be a variety, and assume $p \in V$.
	Then, a regular function $\varphi$ on $U \subseteq V$
	is supposed to be a function on $U$ that ``locally'' is a quotient
	of two functions in $\CC[V]$.

	However, \textbf{as far as the germ is concerned, we only care about
	whichever quotient applies near the point $p$}.
	In light of this, we only think about the representation at $p$,
	and ignore the local clause completely:
	thus the entire stalk can be thought of as
	\[
		\OO_{V,p} = 
		\left\{ \left( \tfrac fg , U \right) \mid 
			U \ni p, \; f,g \in \CC[V], \;
			\text{$g \neq 0$ on $U$} \right\}
	\]
	modulo the usual relations.

	Now, since we happen to be working with complex polynomials,
	we know that a rational function is determined by its
	behavior on any neighborhood of $p$
	(complex analysis forever!).
	Thus 
	\[
		\OO_{V,p} =
		\left\{ \tfrac fg \mid f,g \in \CC[V], \; g(p) \neq 0 \right\}.
	\]
	which don't vanish on $p$.
\end{example}

\begin{remark}
	[Aside for category lovers]
	You may notice that $\SF_p$ seems to be
	``all the $\SF_p(U)$ coming together'', where $p \in U$.
	And in fact, $\SF_p(U)$ is the categorical \emph{limit}
	of the diagram formed by all the $\SF(U)$ such that $p \in U$.
	This is often written
	\[ \SF_p = \varinjlim_{U \ni p} \SF(U) \]
	Thus we can define stalks in any category with limits,
	though to be able to talk about germs the category needs
	to be concrete.
\end{remark}

\section{Sections ``are'' sequences of germs}
\prototype{A real function on $U$ is a sequence of
	real numbers $f(p)$ for each $p \in U$ satisfying some local condition.
	Analogously, a section $s \in \SF(U)$ is a sequence of germs
	satisfying some local compatibility condition.
}
Let $\SF$ be a sheaf on a space $X$ now.
The purpose of this section is to convince you that the correct way
think about a section $s \in \SF(U)$ is as a sequence of germs
above every point $p \in U$.
Put another way: ``a section is determined by its enriched values''.

How do we do this?
Given $s \in \SF(U)$ we consider its germ $[s]_p$ above every for $p \in U$.
To visualize, picture an open set $U \subseteq X$,
and above every point $p \in P$ imagine there is a little speck $[s]_p$,
which bundles the information of $s$ near $p$.
\begin{example}[Real functions vs.\ germs]
	Let $X$ be a space and let $\SF$ be the sheaf of smooth functions 
	Given a section $f \in \SF(U)$,
	\begin{itemize}
		\ii As a function, $f$ is just a choice of value $f(p) \in \RR$ at
		every point $p$, subject to a local ``smooth'' condition.

		\ii Let's now think of $f$ as a sequence of germs.
		At every point $p$ the germ $[f]_p \in \SF_p$ gives us the value $f(p)$
		as we described above. The germ packages even more data than this:
		from the germ $[f]_p$ alone we can for example compute $f'(p)$.
		Nonetheless we stretch the analogy and think of $f$
		as a choice of germ $[f]_p \in \SF_p$ at each point $p$.
	\end{itemize}
	Thus we can replace the notion of the value $f(p)$ with germ $[f]_p$.
	This is useful because in a general sheaf $\SF$, the notion $s(p)$
	is not defined while the notion $[s]_p$ is.
\end{example}

\missingfigure{picture}

From the above example it's obvious that if we know each germ $[s]_p$
this should let us reconstruct the entire section $s$.
Let's check this from the sheaf axioms:
\begin{exercise}
	[Sections are determined by stalks]
	Let $\SF$ be a sheaf.
	Consider the natural map $\SF(U) \to \prod_{p \in U} \SF_p$ described above.
	Show that this map is injective, i.e.\
	the germs of $s$ at every point $p \in U$ determine the section $s$.
	(You will need the ``identity'' sheaf axiom, but not ``collating''.)
\end{exercise}

However, this map is clearly not surjective!
%\begin{ques}
%	Come up with a counterexample to break surjectivity.
%	(This is like asking ``come up with a non-smooth function''.)
%\end{ques}
Nonetheless we can describe the image:
we want a sequence of germs $(g_p)_{p \in U}$ such that near every germ $g_p$,
the germs $g_q$ are ``compatible'' with $g_p$.
We make this precise:
\begin{definition}
	Let $\SF$ be sheaf (or even a pre-sheaf) and $U$ open.
	A sequence $(g_p)_{p \in U}$ of germs
	(with $g_p \in \SF_p$ for each $p$)
	is said to be \vocab{compatible} if
	they can be ``locally collated'':
	\begin{quote}
		For any $p \in U$ there exists a neighborhood $U_p \ni p$
		and a section $s \in \SF(U_p)$ on it
		such that $[s]_q = g_q$ for each $q \in U_p$.
	\end{quote}
	Intuitively, the germs should ``collate together'' to some section near
	each \emph{individual} point $q$
	(but not necessarily to a section on all of $U$).
\end{definition}

We let the reader check this definition is what we want:
\begin{exercise}
	Prove that any choice of compatible germs over $U$
	collates together to a section of $U$.
	(You will need the ``collating'' sheaf axiom, but not ``identity''.)
\end{exercise}

Putting together the previous two exercise gives:
\begin{theorem}
	[Sections ``are'' just compatible germs]
	Let $\SF$ be a sheaf.
	There is a natural bijection between
	\begin{itemize}
		\ii sections of $\SF(U)$, and
		\ii sequences of compatible germs over $U$.
	\end{itemize}
\end{theorem}
This is in exact analogy to the way that e.g.\
a smooth real-valued function on $U$ is a choice
of real number $f(p) \in \RR$ at each point $p \in U$
satisfying a local smoothness condition.

Thus the notion of stalks is what lets us recover the viewpoint
that sections are ``functions''.  Therefore for theoretical purposes,
\begin{moral}
	You should usually think of a section $s \in \SF(U)$ as a sequence of germs.
\end{moral}
In particular, this makes restriction morphisms easy to deal with:
just truncate the sequence of germs!

\section{Sheafification}
\prototype{The pre-sheaf of locally constant functions
	becomes the sheaf of constant functions.}

Now that we have the language of germs,
we can define the so-called sheafification.
The idea is that if $\SF$ is the pre-sheaf of ``functions with property $P$''
then we want to associate a sheaf $\SF\sh$ of
``functions which are locally $P$'', which makes them into a sheaf.
We have already seen two examples of this:
\begin{example}
	[Sheafification]
	\listhack
	\begin{enumerate}[(a)]
		\ii If $X$ is a topological space,
		and $\SF$ is the pre-sheaf of constant functions on open sets of $X$,
		then $\SF\sh$ is the sheaf of locally constant functions.

		\ii If $V$ is an affine variety,
		and $\SF$ is the pre-sheaf of rational functions,
		then $\SF\sh$ is the sheaf of regular functions
		(which are locally rational).
	\end{enumerate}
\end{example}

So how do we encode ``locally $P$''?
Answer: we saw last time that for a sheaf $\SF$,
compatible germs biject to sections.
So we \emph{force} this to be true by defining:
\begin{definition}
	The \vocab{sheafification} $\SF\sh$ of a pre-sheaf $\SF$ is defined by
	\[ \SF\sh(U) =
		\left\{ \text{sequences of compatible
		germs $(g_p)_{p \in U}$} \right\}.  \]
\end{definition}
\begin{exercise}
	Reconcile this definition with the two examples we gave.
\end{exercise}
\begin{abuse}
	Technically I haven't told you what the restriction morphisms
	of $\SF\sh(U)$ are but, they are not hard to guess.
	I'll usually be equally sloppy in the future:
	when defining a sheaf $\SF$, I'll only say what $\SF(U)$ is,
	with the restriction morphisms $\SF(U_2) \to \SF(U_1)$ being implicit.
\end{abuse}
The construction is contrived so that given a section
$(g_p)_{p \in U} \in \SF\sh(U)$ the germ at a point $p$ is $g_p$:
\begin{lemma}
	[Pre-sheaves and sheaves have the same stalk]
	\label{lem:pre_sheaf_stalk}
	Let $\SF$ be a pre-sheaf and $\SF\sh$ its sheafification.
	Then for any point $q$, there is an isomorphism
	\[ (\SF\sh)_q \cong \SF_q. \]
\end{lemma}
\begin{proof}
	A germ in $(\SF\sh)_q$ looks like
	$\left( (g_p)_{p \in U}, U \right)$,
	where $g_p = (s_p, U_p)$ are themselves germs of $\SF_p$,
	and $q \in U$.
	Then the isomorphism is given by
	\[ \left( (g_p)_{p \in U}, U \right) \mapsto g_q \in \SF_q. \]
	The inverse map is given by for each $g = (s,U) \in \SF_q$ by
	\[ g \mapsto \left( (g)_{p \in U}, U \right) \in (\SF\sh)_q \]
	i.e.\ the sequence of germs is the constant sequence.
\end{proof}

\section{Sheaves on a base: forgetting about sheafification}

\section\problemhead
\begin{problem}
	Prove that if $\SF$ is already a sheaf, then $\SF \cong \SF\sh$.
\end{problem}

\begin{sproblem}
	\label{prob:finite_sheaf}
	Suppose $X$ is a finite topological space equipped with the discrete topology
	(i.e.\ $X$ is a finite set of points).
	Let $\SF$ be a sheaf on $X$.
	Show that for any open set $U$, we have a ring isomorphism
	\[ \SF(U) \cong \prod_{p \in U} \SF_p. \]
	Here the product is the product ring as defined in \Cref{ex:product_ring}.
	\begin{hint}
		We have $\SF_p \cong \SF(\{p\})$.
		If $X$ is discrete, then all sequences of germs are compatible.
	\end{hint}
\end{sproblem}

\begin{dproblem}
	[Skyscraper sheaf]
	Let $Y$ be a \emph{Hausdorff} topological space
	and let $p \in Y$ be a point.
	Fix a ring $R$.
	Construct a sheaf $\SF$ on $Y$ by
	\[
		\SF(U) = \begin{cases}
			R & p \in U \\
			0 & \text{otherwise}
		\end{cases}
	\]
	with restriction maps in the obvious manner.
	We call $\SF$ a \vocab{skyscraper sheaf} at $p$.
	Compute all the stalks of $\SF$.
\end{dproblem}

\todo{better problems here}

%\begin{dproblem}
%	[Pushforward sheaf]
%	Suppose $f : X \to Y$ is a continuous map of spaces
%	and $\SF$ is a sheaf on $X$.
%	Define a sheaf $f_\ast \SF$ on $Y$ from $\SF$;
%	we call this the pushforward of $\SF$ onto $Y$.
%\end{dproblem}
%
%\begin{problem}
%	Interpret the skyscraper sheaf as the pushforward
%	of a constant sheaf on a one-point space.
%\end{problem}

